{% extends "dashboards/base_dashboard.html" %}
{% load static %}

{% block extra_css %}
<style>
    .chat-container {
        display: flex;
        flex-direction: column;
        height: 70vh;
    }
    .chat-box {
        flex-grow: 1;
        overflow-y: auto;
        padding: 20px;
        background-color: #f5f7fa;
    }
    .message {
        margin-bottom: 15px;
        display: flex;
        flex-direction: column;
    }
    .message-content {
        padding: 10px 15px;
        border-radius: 18px;
        max-width: 70%;
        word-wrap: break-word;
    }
    .message-meta {
        font-size: 0.75rem;
        color: #98a6ad;
        margin-top: 5px;
    }
    .sent {
        align-items: flex-end;
    }
    .sent .message-content {
        background-color: #5b626b;
        color: #fff;
    }
    .received {
        align-items: flex-start;
    }
    .received .message-content {
        background-color: #ffffff;
        border: 1px solid #e9ecef;
    }
    .chat-input-area {
        border-top: 1px solid #e9ecef;
        padding: 15px;
    }
    .chat-closed-message {
        text-align: center;
        padding: 10px;
        color: #777;
        font-style: italic;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-sm-12">
            <div class="page-title-box">
                <h4 class="page-title">
                    Chat with
                    {% for user in other_participants %}
                        {{ user.username }}{% if not forloop.last %}, {% endif %}
                    {% endfor %}
                </h4>
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'messaging:thread_list' %}">Messages</a></li>
                    <li class="breadcrumb-item active">Conversation</li>
                </ol>
            </div>
        </div>
    </div>
    <div class="card">
        <div class="card-body">
            <div class="chat-container">
                <div id="chat-box" class="chat-box" aria-live="polite" aria-relevant="additions">
                    {% for message in thread_messages %}
                        <div class="message {% if message.sender == request.user %}sent{% else %}received{% endif %}">
                            <div class="message-content">
                                {{ message.text|linebreaksbr }}
                            </div>
                            <div class="message-meta">
                                <span>{{ message.sender.username }}</span> at <span>{{ message.created|date:"M d, P" }}</span>
                            </div>
                        </div>
                    {% empty %}
                        <p>No messages yet. Say hello!</p>
                    {% endfor %}
                </div>
                <div class="chat-input-area">
                    {% if can_send_message %}
                        <div class="input-group">
                            <input type="text" id="chat-message-input" class="form-control" placeholder="Type your message..." autocomplete="off" aria-label="Message input">
                            <div class="input-group-append">
                                <button id="chat-message-submit" class="btn btn-primary" type="button" aria-label="Send message">Send</button>
                            </div>
                        </div>
                    {% else %}
                        <div class="chat-closed-message" role="alert">
                            This conversation is currently inactive. You cannot send new messages.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

{{ thread.id|json_script:"thread-id" }}
{{ request.user.username|json_script:"request-user-username" }}
{{ can_send_message|json_script:"can-send-message" }}
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const threadId = JSON.parse(document.getElementById('thread-id').textContent);
        const requestUserUsername = JSON.parse(document.getElementById('request-user-username').textContent);
        const canSendMessage = JSON.parse(document.getElementById('can-send-message').textContent);

        const chatBox = document.getElementById('chat-box');
        const messageInput = document.getElementById('chat-message-input');
        const messageSubmit = document.getElementById('chat-message-submit');

        // Scroll to the bottom of the chat box on load
        setTimeout(() => {
            chatBox.scrollTop = chatBox.scrollHeight;
        }, 100);

        if (!canSendMessage) {
            console.log('User cannot send messages in this thread.');
            return;
        }

        // Build WebSocket URL
        const wsScheme = window.location.protocol === 'https:' ? 'wss' : 'ws';
        const chatSocket = new WebSocket(
            wsScheme + '://' + window.location.host + '/ws/messaging/' + threadId + '/'
        );

        chatSocket.onopen = function() {
            console.log('WebSocket connection opened.');
            messageInput.focus();
        };

        chatSocket.onerror = function(e) {
            console.error('WebSocket error observed:', e);
        };

        chatSocket.onclose = function(e) {
            console.error('WebSocket connection closed unexpectedly:', e);
            // Optional: add UI feedback for lost connection
        };

        chatSocket.onmessage = function(e) {
            console.log('Received:', e.data);
            const data = JSON.parse(e.data);
            const isSentByMe = data.sender_username === requestUserUsername;

            const messageElement = document.createElement('div');
            messageElement.classList.add('message', isSentByMe ? 'sent' : 'received');

            const contentElement = document.createElement('div');
            contentElement.classList.add('message-content');
            contentElement.innerText = data.message;

            const metaElement = document.createElement('div');
            metaElement.classList.add('message-meta');
            metaElement.innerHTML = `<span>${data.sender_username}</span> at <span>${data.timestamp}</span>`;

            messageElement.appendChild(contentElement);
            messageElement.appendChild(metaElement);
            chatBox.appendChild(messageElement);

            // Scroll to the new message
            chatBox.scrollTop = chatBox.scrollHeight;
        };

        // Send message on Enter key
        messageInput.addEventListener('keyup', function(e) {
            if (e.key === 'Enter') {
                messageSubmit.click();
            }
        });

        messageSubmit.addEventListener('click', function() {
            const message = messageInput.value.trim();
            if (!message) return;

            if (chatSocket.readyState !== WebSocket.OPEN) {
                console.error('Cannot send message: WebSocket is not open.', chatSocket.readyState);
                return;
            }

            chatSocket.send(JSON.stringify({ message }));
            messageInput.value = '';
        });
    });
</script>
{% endblock %}
