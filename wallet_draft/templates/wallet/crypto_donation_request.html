{% extends "dashboards/base_dashboard.html" %}
{% load crispy_forms_tags %}

{% block page_title %}Crypto Donation{% endblock %}

{% block dashboard_content %}
<div class="card shadow-sm">
    <div class="card-header bg-success text-white">
        <h4 class="mb-0">Make a Crypto Donation</h4>
    </div>
    <div class="card-body">
        <p class="card-text">Support us by making a cryptocurrency donation.</p>

        {% if messages %}
            <div class="mb-3">
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}

        <div id="min-amount-display" class="alert alert-info" style="display: none;">
            Minimum donation for <strong id="selected-crypto-code"></strong>: 
            <strong id="min-donation-usd"></strong> USD (<strong id="min-donation-crypto"></strong> <span id="min-donation-crypto-code"></span>)
        </div>

        <form method="post" id="donationForm">
            {% csrf_token %}
            {{ form|crispy }}
            <button type="submit" class="btn btn-success mt-3">Initiate Donation</button>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const cryptoCurrencySelect = document.getElementById('id_crypto_currency');
        const minAmountDisplay = document.getElementById('min-amount-display');
        const selectedCryptoCode = document.getElementById('selected-crypto-code');
        const minDonationUsd = document.getElementById('min-donation-usd');
        const minDonationCrypto = document.getElementById('min-donation-crypto');
        const minDonationCryptoCode = document.getElementById('min-donation-crypto-code');

        const minAmounts = {
            {% for code, data in crypto_min_amounts.items %}
                '{{ code }}': {
                    'usd': {{ data.usd_amount|floatformat:"8" }},
                    'crypto': {{ data.crypto_amount|floatformat:"8" }}
                },
            {% endfor %}
        };

        function updateMinAmountDisplay() {
            const selectedCrypto = cryptoCurrencySelect.value;
            const selectedCryptoText = cryptoCurrencySelect.options[cryptoCurrencySelect.selectedIndex].text;

            if (minAmounts[selectedCrypto]) {
                const usdAmount = minAmounts[selectedCrypto].usd;
                const cryptoAmount = minAmounts[selectedCrypto].crypto;

                selectedCryptoCode.textContent = selectedCryptoText;
                minDonationUsd.textContent = usdAmount.toFixed(8);
                minDonationCrypto.textContent = cryptoAmount.toFixed(8);
                minDonationCryptoCode.textContent = selectedCrypto.toUpperCase();
                minAmountDisplay.style.display = 'block';
            } else {
                minAmountDisplay.style.display = 'none';
            }
        }

        updateMinAmountDisplay();
        cryptoCurrencySelect.addEventListener('change', updateMinAmountDisplay);
    });
</script>
{% endblock %}
