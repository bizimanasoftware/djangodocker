{# wallet/templates/wallet/wallet_dashboard.html #}

{% extends "dashboards/base_dashboard.html" %}

{% block page_title %}My Wallet Dashboard{% endblock %}

{% block dashboard_content %}
<div class="row">
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <h3>Current Wallet Balance</h3>
            </div>
            <div class="card-body">
                <h4 class="card-title">{{ wallet.balance|floatformat:8 }} USD</h4>
                <p class="card-text">Your primary wallet balance.</p>
                <a href="{% url 'wallet:crypto_deposit_request' %}" class="btn btn-primary btn-sm">Deposit Crypto</a>
                <a href="{% url 'wallet:p2p_deposit_request' %}" class="btn btn-info btn-sm">Request P2P Deposit</a>
                <a href="{% url 'wallet:internal_transfer' %}" class="btn btn-secondary btn-sm">Internal Transfer</a>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <h3>Pending P2P Deposit Requests</h3>
            </div>
            <div class="card-body">
                {% if p2p_deposit_transactions %}
                    <ul class="list-group">
                        {% for transaction in p2p_deposit_transactions %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>Amount:</strong> {{ transaction.amount|floatformat:8 }} USD <br>
                                    <strong>Method:</strong> {{ transaction.get_payment_method_display }} <br>
                                    <strong>Status:</strong> <span class="badge bg-warning text-dark">{{ transaction.get_status_display }}</span>
                                    {% if transaction.status == 'awaiting_admin_instructions' %}
                                        <p class="mt-2 text-info">Admin is reviewing your request and will provide payment instructions soon.</p>
                                    {% elif transaction.status == 'awaiting_proof_of_payment' %}
                                        <div class="mt-2">
                                            <p class="text-success"><strong>Payment Instructions from Admin:</strong></p>
                                            <div class="alert alert-success" role="alert">
                                                {{ transaction.admin_payment_instructions|linebreaksbr }}
                                            </div>
                                            {% if not transaction.user_proof_of_payment %}
                                                <a href="{% url 'wallet:p2p_deposit_upload_proof' transaction.transaction_id %}" class="btn btn-success btn-sm mt-2">
                                                    <i class="fas fa-upload me-1"></i> Upload Proof of Payment
                                                </a>
                                            {% else %}
                                                <p class="mt-2 text-muted">Proof already uploaded. Awaiting admin review.</p>
                                            {% endif %}
                                        </div>
                                    {% elif transaction.status == 'review' and transaction.user_proof_of_payment %}
                                        <p class="mt-2 text-info">Your proof of payment has been uploaded and is under admin review.</p>
                                        <a href="{{ transaction.user_proof_of_payment.url }}" target="_blank" class="btn btn-outline-primary btn-sm mt-2">View Uploaded Proof</a>
                                    {% endif %}
                                    {% if transaction.admin_notes %}
                                        <p class="mt-2 text-muted small">Admin Notes: {{ transaction.admin_notes }}</p>
                                    {% endif %}
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="card-text">No pending P2P deposit requests.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3>All Recent Transactions</h3>
            </div>
            <div class="card-body">
                {% if transactions %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Type</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Timestamp</th>
                                    <th>Description</th>
                                    <th>Details</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for tx in transactions %}
                                <tr>
                                    <td>{{ tx.transaction_id|stringformat:"s"|slice:":8" }}...</td> {# Display first 8 chars of UUID #}
                                    <td>{{ tx.get_transaction_type_display }}</td>
                                    <td>{{ tx.amount|floatformat:8 }}</td>
                                    <td><span class="badge bg-{% if tx.status == 'completed' %}success{% elif tx.status == 'pending' or tx.status == 'review' or tx.status == 'awaiting_admin_instructions' or tx.status == 'awaiting_proof_of_payment' %}warning{% else %}danger{% endif %}">{{ tx.get_status_display }}</span></td>
                                    <td>{{ tx.timestamp|date:"Y-m-d H:i" }}</td>
                                    <td>{{ tx.description|default:"N/A" }}</td>
                                    <td>
                                        {% if tx.transaction_type == 'deposit_crypto' and tx.nowpayments_payment_id %}
                                            <a href="https://nowpayments.io/payment/?id={{ tx.nowpayments_payment_id }}" target="_blank" class="btn btn-sm btn-outline-primary">View NOWPayments</a>
                                        {% elif tx.transaction_type == 'withdrawal_crypto' and tx.crypto_address %}
                                            Crypto: {{ tx.crypto_currency }} to {{ tx.crypto_address|slice:":10" }}...
                                        {% elif tx.transaction_type == 'deposit_p2p' or tx.transaction_type == 'withdrawal_p2p' %}
                                            Method: {{ tx.payment_method }}
                                            {% if tx.user_proof_of_payment %}<a href="{{ tx.user_proof_of_payment.url }}" target="_blank" class="btn btn-outline-primary btn-sm">Proof</a>{% endif %}
                                        {% elif tx.transaction_type == 'internal_transfer_send' %}
                                            To: {{ tx.receiver_wallet.user.username }}
                                        {% elif tx.transaction_type == 'internal_transfer_receive' %}
                                            From: {{ tx.sender_wallet.user.username }}
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p>No transactions found.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
