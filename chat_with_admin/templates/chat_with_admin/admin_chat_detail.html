{% extends "dashboards/base_dashboard.html" %}
{% load static %}

{% block title %}Chat with {{ target_user.username }}{% endblock %}

{% block dashboard_content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-md-8 offset-md-2 col-lg-6 offset-lg-3">
            <div class="card shadow-lg border-0">
                <div class="card-header bg-primary text-white text-center">
                    <h5 class="mb-0"><i class="fas fa-comments me-2"></i> Chat with {{ target_user.username }}</h5>
                </div>
                <div class="card-body chat-window" style="height: 400px; overflow-y: auto; display: flex; flex-direction: column; scroll-behavior: smooth;">
                    {% if messages %}
                        {% for message in messages %}
                            <div class="d-flex {% if message.sender_is_admin %}justify-content-end{% else %}justify-content-start{% endif %} mb-2">
                                <div class="message-bubble {% if message.sender_is_admin %}bg-primary text-white{% else %}bg-light text-dark{% endif %} p-2 rounded shadow-sm" style="max-width: 75%;">
                                    <small class="text-muted d-block {% if message.sender_is_admin %}text-end{% endif %}">
                                        {% if message.sender_is_admin %}You (Admin){% else %}{{ target_user.username }}{% endif %} - {{ message.timestamp|date:"M d, H:i" }}
                                    </small>
                                    <div>{{ message.message }}</div>
                                    {# Read status for admin's own messages (from admin's perspective) #}
                                    {% if message.sender_is_admin %}
                                        {% if message.is_read_by_user %}
                                            <small class="text-white-50 d-block text-end">Read</small>
                                        {% else %}
                                            <small class="text-white-50 d-block text-end">Sent</small>
                                        {% endif %}
                                    {% endif %}
                                    {# Read status for user's messages (from admin's perspective) #}
                                    {% if not message.sender_is_admin and message.is_read_by_admin %}
                                        <small class="text-muted d-block text-end">Read</small>
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-center text-muted flex-grow-1 d-flex align-items-center justify-content-center">No messages yet with this user.</p>
                    {% endif %}
                </div>
                <div class="card-footer bg-light">
                    <form id="chat-form" method="post" action="{% url 'chat_with_admin:send_admin_message' %}">
                        {% csrf_token %}
                        <input type="hidden" name="user_id" value="{{ target_user.id }}">
                        <div class="input-group">
                            <textarea name="message" class="form-control" placeholder="Reply to {{ target_user.username }}..." rows="1" required></textarea>
                            <button class="btn btn-primary" type="submit"><i class="fas fa-paper-plane"></i> Send</button>
                        </div>
                    </form>
                    <div id="chatMessageStatus" class="mt-2"></div> {# Status message area #}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_body %}
    {{ block.super }}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script>
        console.log("Chat script loaded for admin_chat_detail.html!"); // VERY FIRST DEBUG LOG

        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOMContentLoaded fired in admin_chat_detail.html."); // Debug

            const chatWindow = document.querySelector('.chat-window');
            if (chatWindow) {
                chatWindow.scrollTop = chatWindow.scrollHeight; // Scroll to bottom on load

                const chatForm = document.getElementById('chat-form');
                const messageInput = chatForm ? chatForm.querySelector('textarea[name="message"]') : null;
                const sendButton = chatForm ? chatForm.querySelector('button[type="submit"]') : null;
                const messageStatusDiv = document.getElementById('chatMessageStatus'); // Get the status div

                if (chatForm && messageInput && sendButton && messageStatusDiv) { // Ensure all elements are found
                    console.log("All chat elements found. Attaching event listener."); // Debug

                    chatForm.addEventListener('submit', async function(e) {
                        console.log("Submit event fired on chat-form (Admin view)."); // Debug: Confirm event listener is active
                        e.preventDefault(); // Stop default form submission
                        console.log("Default form submission prevented."); // Debug 1: Confirm prevention

                        const formData = new FormData(this);

                        // Disable input and button to prevent double submission
                        messageInput.disabled = true;
                        sendButton.disabled = true;
                        sendButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Sending...';

                        // Clear previous status messages
                        messageStatusDiv.innerHTML = '';

                        // Log the message content being sent
                        console.log("Message content:", formData.get('message')); // Debug 2
                        // Log the target user ID for admin replies
                        if (formData.has('user_id')) {
                            console.log("Target User ID (for admin):", formData.get('user_id')); // Debug 3
                        }

                        try {
                            const response = await fetch(this.action, {
                                method: 'POST',
                                body: formData,
                                headers: {
                                    'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                                    'X-Requested-With': 'XMLHttpRequest' // Crucial header for Django's is_ajax() / request.headers.get('x-requested-with') == 'XMLHttpRequest'
                                }
                            });

                            console.log("Received response from server (Raw Response Object):", response); // Debug 4

                            if (!response.ok) { // Check for HTTP errors (e.g., 400, 500)
                                const errorText = await response.text();
                                throw new Error(`HTTP error! Status: ${response.status}, Details: ${errorText.substring(0, 200)}...`);
                            }

                            const data = await response.json(); // Attempt to parse as JSON
                            console.log("Parsed JSON data:", data); // Debug 5

                            if (data.status === 'success') {
                                messageInput.value = ''; // Clear input
                                messageStatusDiv.innerHTML = `<div class="alert alert-success alert-dismissible fade show" role="alert">${data.message}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>`;
                                console.log("Message sent successfully, reloading page."); // Debug 6
                                // Reload after a short delay to allow admin to see success message
                                setTimeout(() => location.reload(), 1500);
                            } else {
                                console.error('Server reported an error (Status not success):', data.message); // Debug 7
                                messageStatusDiv.innerHTML = `<div class="alert alert-danger alert-dismissible fade show" role="alert">${data.message || "Error sending message."}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>`;
                            }
                        } catch (error) {
                            console.error('Fetch error (Network, Parsing, or HTTP Issue):', error); // Debug 8
                            messageStatusDiv.innerHTML = `<div class="alert alert-danger alert-dismissible fade show" role="alert">A network or data parsing error occurred. Please check console for details.<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>`;
                            alert('A network or parsing error occurred. Please check console for details: ' + error.message);
                        } finally {
                            // Re-enable input and button
                            messageInput.disabled = false;
                            sendButton.disabled = false;
                            sendButton.innerHTML = '<i class="fas fa-paper-plane"></i> Send';
                        }
                    });
                } else {
                    console.error("Error: One or more chat elements (form, input, button, status div) not found in admin_chat_detail.html.");
                }
            } else {
                console.error("Error: chat-window element not found in admin_chat_detail.html.");
            }
        });
    </script>
{% endblock %}
